<!DOCTYPE html>
<html>
  <body>
    <section class="page container" id="stamping">
      <div id="stamping-container" >
        <div class="nav-back-container">
          <a class="btn secondary"
             data-bind="click: cancelStamping"
             data-test-id="back-to-application-from-stamping">
              <i class="lupicon-chevron-start"></i>
            <span data-bind =" ltext: 'application.return'"></span>
          </a>
        </div>
        <div class="attachment-multiselect-content" data-bind="if: stampingMode">
          <h1 data-bind="ltext: 'application.stampAttachments'"></h1>
          <div id="stamping-component-container" data-bind="component: {name: 'stamping-component', params: {application: appModel, attachments: attachments, stampFields: stampFields}}"></div>
        </div>
      </div>

      <script type="text/x-jquery-tmpl" id="stamp-attachments-template">
        <div class="stamp-info-container form-grid">
          <form id="stamp-info">
            <div class="row">
              <h3 data-bind="ltext: 'stamp.information'"></h3>

              <div class="col-1">
                <label data-bind="ltext: 'stamp.text'"></label>
                <input data-bind="value: text, enable: status() === statusReady"
                       type="text"
                       class="text"
                       data-test-id="stamp-info-text">
              </div>

              <div class="col-1">
                <label data-bind="ltext: 'stamp.date'"></label>
                <input data-bind="
                            datepicker: date,
                            enable: status() === statusReady,
                            valueUpdate: 'afterkeydown'"
                       type="text"
                       class="text"
                       data-test-id="stamp-info-date">
              </div>

              <div class="col-1">
                <label data-bind="ltext: 'stamp.organization'"></label>
                <input data-bind="textInput: organization, enable: status() === statusReady"
                       type="text"
                       class="text"
                       data-test-id="stamp-info-organization">
              </div>

              <div class="col-1">
                <label data-bind="ltext: 'stamp.text.extra'"></label>
                <input data-bind="value: extraInfo, enable: status() === statusReady"
                       type="text"
                       class="text"
                       data-test-id="stamp-info-extratext">
              </div>

            </div>

            <div class="row">
              <h3 data-bind="ltext: 'stamp.reference-info'"></h3>

              <div class="col-1">
                <label data-bind="ltext: 'stamp.kuntalupatunnus'"></label>
                <input data-bind="textInput: kuntalupatunnus, enable: status() === statusReady"
                       type="text"
                       class="text"
                       data-test-id="stamp-info-kuntalupatunnus"/>
              </div>

              <div class="col-1">
                <label data-bind="ltext: 'stamp.section'"></label>
                <input data-bind="textInput: section, enable: status() === statusReady"
                       type="text"
                       class="text"
                       data-test-id="stamp-info-section">
              </div>

              <div class="col-2">
                <label>&nbsp</label>
                <div class="col--vertical checkbox-wrapper"
                     data-bind="css: {'wrapper--disabled': status() !== statusReady}">
                  <input data-bind="checked: includeBuildings,
                                    disable: status() !== statusReady"
                         type="checkbox" 
                         class="form-input"
                         id="stamp-info-include-buildings">
                  <label data-bind="ltext: 'stamp.include-buildings'" class="inline-label checkbox-label" for="stamp-info-include-buildings"></label>
                </div>
              </div>
            </div>

            <div class="row">
              <h3 data-bind="ltext: 'stamp.margin'"></h3>

              <div class="col-1">
                <label data-bind="text: loc('stamp.xMargin') + ' (' + loc('unit.mm') + ')'"></label>
                <input data-bind="textInput: xMargin,
                            enable: status() === statusReady,
                            css: {'invalid-margin': !xMarginOk()}"
                       type="text"
                       class="text"/
                       data-test-id="stamp-info-xmargin">
              </div>

              <div class="col-1">
                <label data-bind="text: loc('stamp.yMargin') + ' (' + loc('unit.mm') + ')'"></label>
                <input data-bind="textInput: yMargin,
                            enable: status() === statusReady,
                            css: {'invalid-margin': !yMarginOk()}"
                       type="text"
                       class="text"
                       data-test-id="stamp-info-ymargin">
              </div>

              <div class="col-1">
                <label data-bind="ltext: 'stamp.transparency'"></label>
                <select data-bind="options: transparencies, optionsText: 'text', optionsValue: 'value', value: transparency" class="dropdown"
                        data-test-id="stamp-info-transparency"></select>
              </div>

              <div class="col-1">
                <label data-bind="ltext: 'stamp.page'"></label>
                <select data-bind="options: pages, optionsText: 'text', optionsValue: 'value', value: page" class="dropdown"
                        data-test-id="stamp-info-page"></select>
              </div>
            </div>
          </form>
        </div>

        <div class="clear">
            <div data-bind="if: postFiles().length > 0">
              <h1><span data-bind="ltext: 'application.attachments.post-verdict'"></span></h1>
              <div class="clear" data-bind="template: {name: 'stamp-attachments-table', data: postFiles()}"></div>
            </div>
            <div data-bind="if: preFiles().length > 0">
              <h1><span data-bind="ltext: 'application.attachments.pre-verdict'"></span></h1>
              <div class="clear" data-bind="template: {name: 'stamp-attachments-table', data: preFiles()}"></div>
            </div>
          <div class="right">
            <!-- ko ifnot: allSelected -->
            <a href="#" data-bind="ltext: 'stamp.all', click: selectAll, visible: status() < statusRunning" data-test-id="stamp-select-all"></a>
            <!-- /ko -->
            <!-- ko if: allSelected -->
            <a href="#" data-bind="ltext: 'stamp.none', click: selectNone, visible: status() < statusRunning" data-test-id="stamp-select-none"></a>
            <!-- /ko -->
          </div>
        </div>
        <div class="stamp-status">
          <span data-bind="text: loc(['stamp.status', status().toString()])" data-test-id="stamp-status-text"></span>
          <span class="ok icon" data-bind="visible: status() === statusDone"></span>
          <span class="missing icon" data-bind="visible: status() === statusNoFiles"></span>
        </div>

        <div class="attachment-multiselect-buttons">
            <button data-bind="click: start,
                               enable: status() === statusReady && xMarginOk() && yMarginOk() && selectedFiles().length > 0,
                               visible: status() <= statusReady && $parent.authorization.ok('stamp-attachments')"
                    class="positive"
                    data-test-id="start-stamping">
                <i class="lupicon-circle-stamp"></i>
                <span data-bind="ltext: 'stamp.start'"></span>
          </button>
          <button data-bind="
              ltext: 'stamp.reset',
              visible: status() > statusRunning,
              click: $parent.resetStamping"
            class="positive close"
            data-test-id="stamp-reset">
          </button>
          <button data-bind="
              ltext: 'application.return',
              enable: status() !== statusStarting && status() !== statusRunning,
              click: $parent.cancelStamping"
            class="secondary close"
            data-test-id="cancel-stamping">
          </button>
        </div>
      </script>

      <script type="text/x-jquery-tmpl" id="stamp-attachments-table">
        <table class="table attachments-template-table">
          <tbody data-bind="foreach: $data">
            <tr class="attachment-group-header" data-bind="attr: {'data-test-id': $data.groupName}">
              <td data-bind="text: name" colspan="5" data-test-id="attachment-group-header-text"></td>
              <td colspan="2" class="attachment-group-select">
                <!-- ko ifnot: groupSelected -->
                <a href="#" data-bind="ltext: 'attachments.group.select', click: $parents[1].toggleGroupSelect, visible: $parents[1].status() < $parents[1].statusRunning"
                            data-test-id="attachments-group-select"></a>
                <!-- /ko -->
                <!-- ko if: groupSelected -->
                <a href="#" data-bind="ltext: 'attachments.group.deselect', click: $parents[1].toggleGroupSelect, visible: $parents[1].status() < $parents[1].statusRunning"
                            data-test-id="attachments-group-deselect"></a>
                <!-- /ko -->
              </td>
            </tr>
            <tr>
              <th data-bind="ltext: 'application.attachmentState'">Tila</th>
              <th colspan="2" data-bind="ltext: 'application.attachmentType'">Tyyppi</th>
              <th data-bind="ltext: 'application.attachmentFile'">Tiedosto</th>
              <th data-bind="ltext: 'application.attachmentVersion'">Versio</th>
              <th data-bind="ltext: 'application.attachmentEditDate'">Muokattu</th>
              <th></th>
            </tr>

            <!-- ko foreach: attachments -->
            <tr class="attachment-row attachment-multiselect-row" data-bind="click: $parents[2].selectRow, clickBubble: false, css: {selected: selected}">
              <td data-bind="foreach: lupapisteApp.services.attachmentsService.stateIcons( $data )">
                <i data-bind="attr: {'class': $data.css,
                              'data-test-icon':  $data.icon + '-icon'}"></i>
              </td>
              <td class="attachment-type-group">
                  <span data-bind="if: type">
                    <span data-bind="text: loc(['attachmentType', type['type-group'], '_group_label'])"></span>
                  </span>
                  <span data-bind="if: !type">
                    <i data-bind="ltext: 'attachment.noName'"></i>
                  </span>
              </td>
              <td class="attachment-type-id">
                  <span data-bind="if: type">
                    <span data-bind="text: loc(['attachmentType', type['type-group'], type['type-id']])"></span>
                  </span>
                  <span data-bind="if: !type">
                    <i data-bind="ltext: 'attachment.noName'"></i>
                  </span>
                  <div class="attachment-content-desc" data-bind="if: $data.contents"><span data-bind="text: $data.contents" data-test-id="attachment-contents"></span></div>
              </td>
              <td class="attachment-file-info">
                <span data-bind="if: $data.latestVersion">
                  <a href="#" data-bind="text: latestVersion.filename,
                                         attr: {href: '/api/raw/download-attachment?attachment-id=' + fileId(),
                                                title: loc('download')},
                                         click: function() {return true;},
                                         clickBubble: false"></a><br/>
                  <i data-bind="ltext: latestVersion.contentType"></i>
                  <i data-bind="size: latestVersion.size"></i>
                </span>
                <!-- ko ifnot: $data.latestVersion -->
                <a data-bind="ltext: 'application.attachmentsAddList', attr: {href: '#!/attachment/' + $root.application.id() + '/' + id, 'data-test-type': type['type-group'] + '.' + type['type-id']}"></a>
                <!-- /ko -->
              </td>
              <td class="attachment-version-info">
                <span data-bind="if: $data.latestVersion">
                  <span data-bind="version: latestVersion.version"></span>
                </span>
              </td>
              <td class="attachment-file-changed">
                <span data-bind="if: $data.latestVersion">
                  <span data-bind="dateString: modified"></span>
                  <span data-bind="fullName: latestVersion.user"></span>
                </span>
              </td>
              <td>
                <div class="stampbox-wrapper"
                     data-bind="visible: $parents[2].status() < $parents[2].statusRunning">
                  <input type="checkbox" data-bind="checked: $data.selected,
                                                    enable: $parents[2].status() === $parents[2].statusReady,
                                                    attr: {id: $data.fileId}">
                  
                  <label class="stampbox-label"
                         data-bind="attr: {'for': $data.fileId}"></label>
                </div>
                  <span data-bind="
                      text: loc(['stamp.file.status', $data.status()]),
                      visible: $parents[2].status() >= $parents[2].statusRunning"
                      data-test-id="attachment-status-text"></span>
              </td>
            </tr>

            <!-- /ko -->
          </tbody>
        </table>
     </script>
    </section>
  </body>
</html>
