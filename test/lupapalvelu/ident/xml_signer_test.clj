(ns lupapalvelu.ident.xml-signer-test
  (:require [clojure.java.io :as io]
            [clojure.test :as t]
            [lupapalvelu.ident.xml-signer :as xml-signer])
  (:import [org.apache.ws.security WsuIdAllocator]))

(def test-message
  (str "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\">"
       "<soapenv:Body><foo>bar</foo></soapenv:Body></soapenv:Envelope>"))

(t/deftest soap-signing-test
  (let [cert         (slurp (io/resource "certificate/soap-signing-test.crt"))
        private-key  (slurp (io/resource "certificate/soap-signing-test.key"))
        id-number    (atom 0)
        id-allocator (reify WsuIdAllocator
                       (createId [_ prefix _]
                         (str prefix "test-id-" (swap! id-number inc)))
                       (createSecureId [_ prefix _]
                         (str prefix "test-secure-id-" (swap! id-number inc))))]
    (t/is (= "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"><soapenv:Header><wsse:Security xmlns:wsse=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd\" xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\" soapenv:mustUnderstand=\"1\"><wsse:BinarySecurityToken EncodingType=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-soap-message-security-1.0#Base64Binary\" ValueType=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3\" wsu:Id=\"X509-test-secure-id-2\">MIIDkDCCAngCCQDPO1LUkvgKbTANBgkqhkiG9w0BAQsFADCBiTELMAkGA1UEBhMCRkkxGTAXBgNVBAMMEFNpbW8gU3V1cnZpc2lpcmkxGTAXBgNVBAsMEFJha2VubnVzdmFsdm9udGExEDAOBgNVBAgMB1V1c2ltYWExDjAMBgNVBAcMBVNpcG9vMQ4wDAYDVQQKDAVTaXBvbzESMBAGA1UEAwwJTG9jYWwgSURQMB4XDTE4MDgwMjE0MDYzN1oXDTM4MDcyODE0MDYzN1owgYkxCzAJBgNVBAYTAkZJMRkwFwYDVQQDDBBTaW1vIFN1dXJ2aXNpaXJpMRkwFwYDVQQLDBBSYWtlbm51c3ZhbHZvbnRhMRAwDgYDVQQIDAdVdXNpbWFhMQ4wDAYDVQQHDAVTaXBvbzEOMAwGA1UECgwFU2lwb28xEjAQBgNVBAMMCUxvY2FsIElEUDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJ15PMS7dYmOaZGlkv1SEQdVa1SCPrvdi8ty/JniZGIb+M8osjqJbo6WIlO6NNq0DAQPt0qDzSCxVQDC5t6R60mb49JRQvq+l1xV74liDF+8uKBtaER3MQrmCMu7MWadOTzVOfxfNMMla60N/pKHXDhokJsucs993oLL24fPuHfWW7KC5YDwHdOk3OrPv+Z3bF6zORvugyZMiK3J2kBViIBxUt/qtWKZxukPQjnOO2Q4jnj4WfMHwAjzFyw+uTS/B0p+FYtgjqjCjiMVywRbdQCwtRWRl0kelGG0o7jviCuoppj+qIQhY36qubY5Jz51uZyWfQOih/e2txQZWzx8T7MCAwEAATANBgkqhkiG9w0BAQsFAAOCAQEATNvnLh2dqpfExbbRn8toVlsyqaKy7gRW218mwsCr+d0Z7abi4T1Z+dApezEgvBIOw1QHgzvccjciKfOkhH/iEekufOSK16xl2+EPQwsZ/6KsncRWnMf2QUnnvzV8FU/xlEZJhON1zNOz3/YsDNzV8ZS+diElsZsL7sDna8QhVnUWh0VyfAohgqBRd6ATp5pSYZXWqOF8JLEFKvBtEyTTDnXS7kJrWqSQh2Iq8XRtgCyz7PhJKjU2cC7TVenI3mq4upzoCgwmt0RRPrKu78SQySo46M/dqDZNqjO/7nAyUjdBkHRsyoZF2IVOkCGDQEHXMYa8QxeKFIZzM6IZYMEuMA==</wsse:BinarySecurityToken><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\" Id=\"SIG-test-id-6\"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"><ec:InclusiveNamespaces xmlns:ec=\"http://www.w3.org/2001/10/xml-exc-c14n#\" PrefixList=\"soapenv\"></ec:InclusiveNamespaces></ds:CanonicalizationMethod><ds:SignatureMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#rsa-sha1\"></ds:SignatureMethod><ds:Reference URI=\"#TS-test-id-1\"><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"><ec:InclusiveNamespaces xmlns:ec=\"http://www.w3.org/2001/10/xml-exc-c14n#\" PrefixList=\"wsse soapenv\"></ec:InclusiveNamespaces></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#sha1\"></ds:DigestMethod><ds:DigestValue>kzT8TLLgHHJiqBgBe/pN2rjLa0U=</ds:DigestValue></ds:Reference><ds:Reference URI=\"#id-test-id-5\"><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"><ec:InclusiveNamespaces xmlns:ec=\"http://www.w3.org/2001/10/xml-exc-c14n#\" PrefixList=\"\"></ec:InclusiveNamespaces></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#sha1\"></ds:DigestMethod><ds:DigestValue>KPTls/NIAczkJieIrsOgtBY3LWE=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>Ie6gOOKpH76X9olifrMdA71WQEFQ/peSVP2sMTq+Bf7f3UgznFJT0eUj5HSvRRkQ0Ovyo/izkY5V4HnEqR1JNx+y923AX0248qFufTbB7FQdxBZLVMWvCjl8ktuodgYuuLHf1K2FuW0sNDX1vGX0AeFqoY5+Wg/xJXSh2pilF873XufzVX+f+OQ26++MmeNGAXoJzsLRAaelh553iv/5UZGVGOcqxNFMozrpYWhAS8myc1qKiRU62KweU6bLPBmM2iNLsGD7oqBLpNxORpINCwT5fBHpIISAZjYpoUTUEMTGjHM2e+CbzeEhQsmHt5SijhDuoLZxbVtV9NefZ5z+gQ==</ds:SignatureValue><ds:KeyInfo Id=\"KI-test-secure-id-3\"><wsse:SecurityTokenReference wsu:Id=\"STR-test-secure-id-4\"><wsse:Reference URI=\"#X509-test-secure-id-2\" ValueType=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3\"></wsse:Reference></wsse:SecurityTokenReference></ds:KeyInfo></ds:Signature><wsu:Timestamp wsu:Id=\"TS-test-id-1\"><wsu:Created>2022-04-19T12:12:06.687Z</wsu:Created><wsu:Expires>2022-04-19T12:13:06.687Z</wsu:Expires></wsu:Timestamp></wsse:Security></soapenv:Header><soapenv:Body xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\" wsu:Id=\"id-test-id-5\"><foo>bar</foo></soapenv:Body></soapenv:Envelope>"
             (xml-signer/sign-soap-envelope-xml-string cert
                                                       private-key
                                                       {:current-inst #inst"2022-04-19T12:12:06.687-00:00"
                                                        :id-allocator id-allocator}
                                                       test-message))
          "SOAP message signing produces expected signature")))
